rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner() {
      return isSignedIn() && request.auth.uid == request.resource.data.userId;
    }


    function _commentCount(data) {
      return (data.commentCount is number) ? data.commentCount : 0;
    }

    function isPostCommentInteraction() {
      return isSignedIn()
        && resource.data != null
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.email == resource.data.email
        && request.resource.data.imageUrl == resource.data.imageUrl
        && request.resource.data.caption == resource.data.caption
        && request.resource.data.timestamp == resource.data.timestamp
        && request.resource.data.likeCount == resource.data.likeCount
        && request.resource.data.likedBy == resource.data.likedBy
        && request.resource.data.keys().hasOnly(['userId','email','imageUrl','caption','timestamp','likeCount','likedBy','commentCount','updatedAt'])
        && request.resource.data.commentCount is number
        && request.resource.data.commentCount == _commentCount(resource.data) + 1
        && request.resource.data.updatedAt == request.time;
    }
    function isPostLikeInteraction() {
      return isSignedIn()
        && resource.data != null
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.email == resource.data.email
        && request.resource.data.imageUrl == resource.data.imageUrl
        && request.resource.data.caption == resource.data.caption
        && request.resource.data.timestamp == resource.data.timestamp
        && request.resource.data.keys().hasOnly(['userId','email','imageUrl','caption','timestamp','likeCount','likedBy','commentCount','updatedAt'])
        && request.resource.data.likeCount is number
        && request.resource.data.commentCount == _commentCount(resource.data)
        && request.resource.data.likedBy is list
        && request.resource.data.updatedAt == request.time;
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;

      match /friends/{friendId} {
        allow read, delete: if isSignedIn() && request.auth.uid == userId;
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.keys().hasOnly(['userId','displayName','email','membershipLevel','addedAt'])
          && request.resource.data.userId is string
          && request.resource.data.displayName is string && request.resource.data.displayName.size() > 0
          && (request.resource.data.email == null || request.resource.data.email is string)
          && (request.resource.data.membershipLevel == null || request.resource.data.membershipLevel is string)
          && request.resource.data.addedAt == request.time;
      }

      match /followers/{followerId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn()
          && request.auth.uid == followerId
          && request.resource.data.keys().hasOnly(['userId','displayName','email','membershipLevel','addedAt'])
          && request.resource.data.userId is string
          && request.resource.data.userId == followerId
          && request.resource.data.displayName is string
          && request.resource.data.displayName.size() > 0
          && (request.resource.data.email == null || request.resource.data.email is string)
          && (request.resource.data.membershipLevel == null || request.resource.data.membershipLevel is string)
          && request.resource.data.addedAt == request.time;
        allow delete: if isSignedIn() && (request.auth.uid == followerId || request.auth.uid == userId);
      }

      match /following/{targetId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.keys().hasOnly(['userId','displayName','email','membershipLevel','addedAt'])
          && request.resource.data.userId is string
          && request.resource.data.userId == targetId
          && request.resource.data.displayName is string
          && request.resource.data.displayName.size() > 0
          && (request.resource.data.email == null || request.resource.data.email is string)
          && (request.resource.data.membershipLevel == null || request.resource.data.membershipLevel is string)
          && request.resource.data.addedAt == request.time;
        allow delete: if isSignedIn() && request.auth.uid == userId;
      }
 

      match /whiskeyCollection/{whiskeyId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      match /whiskeyWishlist/{whiskeyId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      match /favoriteDistilleries/{distilleryId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      match /favoriteArticles/{articleId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    match /whiskeys/{whiskeyId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.keys().hasOnly([
          'userId','userName','userEmail','membershipLevel','name','brand','distilleryId','distilleryName',
          'country','countryCode','region','category','subCategory','ageStatement','abv','proof',
          'releaseType','vintageOrBatch','yearReleased','msrp','priceLow','priceHigh','rarityLevel',
          'availabilityStatus','shortDescription','notes','tags','isHighlighted','imageUrl','style','createdAt'])
        && request.resource.data.name is string && request.resource.data.name.size() > 0
        && request.resource.data.country is string && request.resource.data.country.size() > 0
        && request.resource.data.region is string && request.resource.data.region.size() > 0
        && request.resource.data.category is string && request.resource.data.category.size() > 0
        && request.resource.data.subCategory is string
        && request.resource.data.ageStatement is string
        && request.resource.data.abv is number
        && (request.resource.data.proof == null || request.resource.data.proof is number)
        && request.resource.data.releaseType is string && request.resource.data.releaseType.size() > 0
        && (request.resource.data.brand == null || request.resource.data.brand is string)
        && (request.resource.data.distilleryId == null || request.resource.data.distilleryId is string)
        && (request.resource.data.distilleryName == null || request.resource.data.distilleryName is string)
        && (request.resource.data.countryCode == null || request.resource.data.countryCode is string)
        && (request.resource.data.vintageOrBatch == null || request.resource.data.vintageOrBatch is string)
        && (request.resource.data.yearReleased == null || request.resource.data.yearReleased is number)
        && request.resource.data.msrp is number
        && request.resource.data.priceLow is number
        && request.resource.data.priceHigh is number
        && request.resource.data.rarityLevel is string
        && request.resource.data.availabilityStatus is string
        && request.resource.data.shortDescription is string
        && request.resource.data.notes is string
        && request.resource.data.tags is list
        && request.resource.data.isHighlighted is bool
        && (request.resource.data.imageUrl == null || request.resource.data.imageUrl is string)
        && request.resource.data.style is string
        && request.resource.data.createdAt == request.time;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    match /distilleries/{distilleryId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.keys().hasOnly([
          'userId','userName','userEmail','membershipLevel','name','type','country','region','stateOrProvince','city',
          'isVisitAble','primaryStyles','shortDescription','websiteUrl','imageUrl','tags','location','story',
          'signaturePour','createdAt'])
        && request.resource.data.name is string && request.resource.data.name.size() > 0
        && request.resource.data.type is string && request.resource.data.type.size() > 0
        && request.resource.data.country is string && request.resource.data.country.size() > 0
        && request.resource.data.region is string && request.resource.data.region.size() > 0
        && request.resource.data.stateOrProvince is string
        && request.resource.data.city is string
        && request.resource.data.isVisitAble is bool
        && request.resource.data.primaryStyles is list
        && request.resource.data.shortDescription is string
        && (request.resource.data.websiteUrl == null || request.resource.data.websiteUrl is string)
        && (request.resource.data.imageUrl == null || request.resource.data.imageUrl is string)
        && request.resource.data.tags is list
        && request.resource.data.location is string
        && request.resource.data.story is string
        && request.resource.data.signaturePour is string
        && request.resource.data.createdAt == request.time;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    match /articles/{articleId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.keys().hasOnly([
          'userId','userName','userEmail','membershipLevel','title','subtitle','category',
          'tags','markdownFilename','markdownPath','imageFilename','imagePath','iconUrl','createdAt'])
        && request.resource.data.title is string && request.resource.data.title.size() > 0
        && request.resource.data.category is string && request.resource.data.category.size() > 0
        && request.resource.data.tags is list
        && request.resource.data.markdownFilename is string && request.resource.data.markdownFilename.size() > 0
        && request.resource.data.markdownPath is string && request.resource.data.markdownPath.size() > 0
        && (!request.resource.data.keys().hasAny(['subtitle']) || request.resource.data.subtitle is string)
        && (!request.resource.data.keys().hasAny(['imageFilename']) || request.resource.data.imageFilename is string)
        && (!request.resource.data.keys().hasAny(['imagePath']) || request.resource.data.imagePath is string)
        && (!request.resource.data.keys().hasAny(['iconUrl']) || request.resource.data.iconUrl is string)
        && request.resource.data.createdAt == request.time;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    match /merch/{itemId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn()
        && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    function _chatRoomHasUser(data) {
      return data.participantIds is map
        && request.auth != null
        && data.participantIds[request.auth.uid] == true;
    }

    function _isChatRoomParticipant(roomId) {
      return request.auth != null
        && roomId is string
        && exists(/databases/$(database)/documents/chatRooms/$(roomId))
        && _chatRoomHasUser(get(/databases/$(database)/documents/chatRooms/$(roomId)).data);
    }

    match /chatRooms/{roomId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    match /events/{eventId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.keys().hasOnly([
          'userId','title','location','details','date','createdAt'])
        && request.resource.data.title is string && request.resource.data.title.size() > 0
        && request.resource.data.location is string && request.resource.data.location.size() > 0
        && request.resource.data.details is string
        && request.resource.data.date is timestamp
        && request.resource.data.createdAt == request.time;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    match /messages/{messageId} {
      allow read: if (isSignedIn() &&
          (request.auth.uid == resource.data.fromUserId ||
           request.auth.uid == resource.data.toUserId))
        || _isChatRoomParticipant(resource.data.chatRoomId);
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.fromUserId;
      allow delete: if isSignedIn() &&
        (request.auth.uid == resource.data.fromUserId ||
         request.auth.uid == resource.data.toUserId);
    }

    match /posts/{postId} {
      allow read: if true;
      allow create: if isOwner() &&
        request.resource.data.keys().hasOnly(['userId','email','imageUrl','caption','timestamp','likeCount','likedBy','commentCount','updatedAt']) &&
        request.resource.data.userId is string && request.resource.data.email is string &&
        request.resource.data.imageUrl is string && request.resource.data.caption is string &&
        request.resource.data.timestamp == request.time &&
        request.resource.data.likeCount is number && request.resource.data.likeCount == 0 &&
        request.resource.data.likedBy is list && request.resource.data.likedBy.size() == 0 &&
        request.resource.data.commentCount is number && request.resource.data.commentCount == 0 &&
        request.resource.data.updatedAt == request.time;
      allow update: if (isSignedIn() && request.auth.uid == resource.data.userId)
        || isPostLikeInteraction()
        || isPostCommentInteraction();
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn()
          && request.auth.uid == request.resource.data.userId
          && request.resource.data.postId == postId
          && request.resource.data.keys().hasOnly(['postId','userId','userName','userEmail','membershipLevel','text','timestamp'])
          && request.resource.data.userId is string
          && request.resource.data.userName is string && request.resource.data.userName.size() > 0
          && request.resource.data.userEmail is string
          && (request.resource.data.membershipLevel is string || request.resource.data.membershipLevel == null)
          && request.resource.data.text is string && request.resource.data.text.size() > 0
          && request.resource.data.timestamp == request.time;
        allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
      }
    }
  }
}
